---
title: "Watershed Delineator"
author: "A. Thompson, T. Pritchard"
date: "2026-01-27"
output: html_document
  TOC: TRUE
---

# **WATERSHED DELINEATION TOOL**

#### Purpose: Create watershed polygons upstream of a starting set of coordinates or COMIDs. Useful for evaluating human disturbances to screen sites for reference condition.

# **1 - ASSIGN COMIDS**

#### First assign and review COMIDs manually or via RATS' batch COMID script (<link>). All stations must have a valid COMID before proceeding.

# **2 - LOAD PACKAGES**

```{r}
library(nhdplusTools)
library(sf)
library(tidyverse)
library(mapview)
library(openxlsx)
library(AWQMSdata)
```

# **3 - SPECIFY OUTPUT SHAPEFILE**

```{r}
export <- "C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willytest.shp"
```

# **3 - IMPORT DATA**

#### Choose *ONE* of the following three methods for importing sites/COMIDs. Update file paths.

#### If wanting to delineate a single watershed, use USGS StreamStats instead (<https://streamstats.usgs.gov/ss/>).

## OPTION A - *EXCEL*

```{r}
import <- read.xlsx("C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/WillyTable.xlsx")
```

## OPTION B - *SHAPEFILE*

```{r}
import <- st_read("C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willy.shp")
```

## OPTION C - *STATIONS DATABASE*

```{r}
# IMPORT ALL STATIONS FROM STATIONS DB
stations <- query_stations()

# NARROW TO STATIONS OF INTEREST
import <- stations |>
  filter(MLocID %in% c("21848-ORDEQ", "32587-ORDEQ")) #<--Enter desired MLocIDs
```

# **4 - CREATE COMID DATAFRAME**

```{r}
dataframe_comid <- data.frame(import$COMID) #<--Might need to change format depending on data source (e.g., COMID vs ComID)
```

# **5 - RUN DELINEATION FUNCTION**

```{r}
# WRITE FUNCTION
delin <- function(comid, ofid2, random, shp_file){

# CALL SHAPEFILE WHERE DELINEATIONS WILL BE SAVED
shp_file <- export

# CALL STARTING COMID
start_comid <- dataframe_comid$import.COMID
#start_comid <- "23759604" #option for delineating a single COMID

# MAKE FLOWLINES
flowlines <- navigate_nldi(list(featureSource = "comid",
                                featureID = start_comid),
                           mode = "upstreamTributaries",
                           distance_km = 1000)

# CREATE TEMPORARY GEOPACKAGE
subset_file <- tempfile(fileext = ".gpkg")

# SUBSET DATA
subset <- subset_nhdplus(comids = as.integer(flowlines$UT$nhdplus_comid),
                         output_file = subset_file,
                         nhdplus_data = "download",
                         flowline_only = FALSE,
                         return_data = TRUE, overwrite = TRUE)

# CREATE CATCHMENT POLYGONS
catchment <- sf::read_sf(subset_file, "CatchmentSP")

# UNIFY INTO SINGLE POLYGON
catchment <- sf::st_union(catchment)

# DRAW THE FLOW NETWORK
flownet <- subset$NHDFlowline_Network

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# CALCULATE WATERSHED AREA (m2)
#catchment$area_sqm <- st_area(catchment)

# REPROJECT TO NAD83 / OREGON GIC LAMBERT (ft)
catchment2 <- st_sf(catchment)|> 
  mutate(orig_comid = comid,
         ofid = ofid2,
         rand = random) |>
  st_transform(crs = 2992)
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# APPEND WATERSHEDS TO SHAPEFILE
st_write(catchment, shp_file, append = TRUE)
}
```

# **5 - VIEW MAP PRODUCTS (*OPTIONAL*)**

```{r}
mapview(catchment, col.regions = "lightgreen") + mapview(flownet, color = "blue",
  map.types = mapviewGetOption("basemaps"))
                                                         
#map.types = mapviewGetOption("basemaps"
```

# **6 - WRITE TO SHAPEFILE**

```{r}
#OPTION A 
purrr::pmap(as.list(dataframe_comid), ~ delin(comid = {..8}, random = {..1}, ofid2 = {..3}, shp_file = "C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/delineate_test.shp" ))

#OPTION B
purrr::map(dataframe_comid, ~ delin(.,shp_file = "C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/delineate_test.shp" ))
```

# **7 - QC AND CORRECT WATERSHEDS IN GIS ACCORDING TO SECTION X OF <_SOP>**

# **THE END**
