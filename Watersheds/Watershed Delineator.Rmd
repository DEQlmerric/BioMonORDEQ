---
title: "Watershed Delineator"
author: "A. Thompson, T. Pritchard"
date: "2026-01-27"
output: html_document
  TOC: TRUE
---

# **WATERSHED DELINEATION TOOL**

#### Purpose: Batch create watershed polygons upstream of a starting set of coordinates or COMIDs. Useful for evaluating human disturbances to screen sites for reference condition.

# **1 - ASSIGN COMIDS**

#### First assign and review COMIDs manually or via RATS' batch COMID script (<link>). All stations must have a valid COMID before proceeding.

# **2 - LOAD PACKAGES**

```{r}
library(nhdplusTools)
library(sf)
library(tidyverse)
library(mapview)
library(openxlsx)
library(AWQMSdata)
```

# **3 - SPECIFY OUTPUT FILE**

#### Choose *ONE* of the following two file types for exporting delineated watersheds. Update file path.

## OPTION A - *ARCGIS SHAPEFILE*

```{r}
export <- "C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willytest5.shp"
```

## OPTION B - *GOOGLE EARTH KML*

```{r}
export <- "C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willytest.kml"
```

# **3 - IMPORT DATA**

#### Choose *ONE* of the following three methods for importing sites/COMIDs. Update file path.

#### Use USGS StreamStats to delineate a single watershed <https://streamstats.usgs.gov/ss/>.

## OPTION A - *EXCEL*

```{r}
import <- read.xlsx("C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/WillyTable.xlsx")
```

## OPTION B - *SHAPEFILE*

```{r}
import <- st_read("C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willy.shp")
```

## OPTION C - *STATIONS DATABASE*

```{r}
# RETURN ALL STATIONS FROM STATIONS DB
import <- query_stations(mlocs = c("21848-ORDEQ","10404-ORDEQ","ODFW-10662")) #<--Enter desired MLocIDs in quotes separated by commas
```

# **4 - CREATE COMID DATAFRAME**

```{r}
# MAKE DATAFRAME CONTAINING ALL COMIDS FROM USER-SELECTED INPUT METHOD
# DROP ROWS WITH MISSING COMIDS (e.g., STATIONS ON HIGH RESOLUTION NHD LAYER WITH NO REPRESENTATIVE COMIDS, DENOTED BY "-99999")
dataframe_comid <- import |>
  select(COMID, MLocID) |>
    filter(COMID != '-99999' | !is.na(COMID))

# CREATE TEMPORARY GEOPACKAGE
subset_file <- tempfile(fileext = ".gpkg")
```

# **5 - RUN DELINEATION FUNCTION**

```{r}
# RUN FUNCTION
delin <- function(comid, MLocID, save_file){

# MAKE FLOWLINES
flowlines <- navigate_nldi(list(featureSource = "comid",
                                featureID = comid),
                           mode = "upstreamTributaries",
                           distance_km = 1000)

# SUBSET DATA
subset <- subset_nhdplus(comids = as.integer(flowlines$UT$nhdplus_comid),
                         output_file = subset_file,
                         nhdplus_data = "download",
                         flowline_only = FALSE,
                         return_data = TRUE, overwrite = TRUE)

# CREATE CATCHMENT POLYGONS
catchment <- sf::read_sf(subset_file, "CatchmentSP")

# UNIFY INTO SINGLE POLYGON
catchment <- sf::st_union(catchment)

# DRAW THE FLOW NETWORK
flownet <- subset$NHDFlowline_Network

# REPROJECT TO NAD83 / OREGON GIC LAMBERT (ft)
catchment2 <- st_sf(catchment)|> 
  mutate(COMID = comid,
         MLocID = MLocID) |>
  st_transform(crs = 2992)

# CALCULATE WATERSHED AREA (m2)
catchment2$Shape_Area <- st_area(catchment2) * 0.092903

# APPEND WATERSHEDS TO SHAPEFILE
st_write(catchment2, save_file, append = TRUE)
}
```

# **5 - VIEW MAP PRODUCTS (*OPTIONAL*)**

```{r}
mapview(catchment2, col.regions = "palegreen", layer.name = "Watershed", alpha.regions = 0.5, legend = FALSE) + 
  mapview(flownet, color = "royalblue", layer.name = "Flow Network", legend = FALSE)

mapviewOptions(basemaps = c("OpenTopoMap","Esri.WorldImagery"))
```

# **6 - WRITE TO SHAPEFILE**

```{r}
purrr::pmap(dataframe_comid, ~delin(comid = {..1}, MLocID = {..2}, save_file = export))
```

# **7 - QC AND CORRECT WATERSHEDS IN GIS**

#### REFER TO STATEWIDE REFERENCE SELECTION PROTOCOLS (DEQ21-LAB-0026-SOP)

# **THE END**
