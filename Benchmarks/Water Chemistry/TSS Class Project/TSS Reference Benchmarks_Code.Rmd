---
title: "TSS Reference Benchmarks"
author: "S. Berzins, A. Thompson"
date: "2025-10-21"
output: html_document
---

#### **PREFACE:** This script explores the creation of a site-specific reference benchmark for total suspended solids (TSS) for ESM 566 Fall Environmental Statistics final project.

# **1 - LOAD PACKAGES**

```{r}
library(AWQMSdata) #visit 'https://github.com/TravisPritchardODEQ/AWQMSdata' for installation instructions
library(StreamCatTools) #visit 'https://github.com/USEPA/StreamCatTools' for installation instructions
library(tidyverse)
library(readxl)
```

# **2 - IMPORT DATA**

## STATIONS - *FROM DEQ STATIONS DATABASE*

#### Pull all sites with a reference status designation

```{r}
stations <- query_stations()
ref_stations <- stations %>% 
  filter(ReferenceSite %in% c("REFERENCE" , "MODERATELY DISTURBED", "MOST DISTURBED")) %>% 
  select(MLocID, COMID, ReferenceSite, OrgID)
rm(stations)
```

## WATER CHEMISTRY DATA - *FROM AWQMS*

#### Total suspended solids (TSS) data for sites with a reference status designation

```{r}
tss <- AWQMS_Data(MLocID = ref_stations$MLocID, Char_Name = 'Total suspended solids')
```

#### Merge AWQMS and Stations data into single dataframe

```{r}
tss.all <- inner_join(tss, ref_stations, by = "MLocID")
```

## WATERSHED METRICS - *FROM EPA STREAMCAT*

#### Can search for predictors of interest here: <https://www.epa.gov/national-aquatic-resource-surveys/streamcat-metrics-and-definitions>

# do correlation analysis for streamcat predictors - which covary with each other? Get all predictors for watersheds. 
# need to query catchment data when we "Used closest COMID"

```{r}
comids <- read_excel("TSS_COMIDs.xlsx") #output file from ref benchmarks script

scaoi <-StreamCatTools::sc_get_params(param = 'aoi') #make list of all sc aois
print(paste0('Area of interest available parameters are: ', paste(scaoi, collapse = ', ')))

scpar <- StreamCatTools::sc_get_params(param = 'metric_names') #make list of all sc metrics
print(paste0('Parameters names are: ', paste(scpar, collapse = ', ')))


comids_split <- split(comids2, ceiling(seq_along(comids2)/750)) #this isn't really splitting them into chunks of 750 ???
metrics_split <- split(scpar, ceiling(seq_along(scpar)/750)) #seems to work, as now have two lists, first one cutting off at 750

streamcat <- purrr::map_dfr(comids_split, ~StreamCatTools::sc_get_data(comid = .,
                                                                           metric = "all",
                                                                           showAreaSqKm = TRUE,
                                                                           aoi='catchment,watershed,other'))


# single comid, all metrics, one aoi (can't handle all metrics and all aois)
single <- StreamCatTools::sc_get_data(comid = '23648454', metric = 'all', showAreaSqKm = TRUE, aoi='catchment')



myfunction <- function(comids, scaoi) {
  comids <- read_excel("TSS_COMIDs.xlsx") #output file from ref benchmarks script
  scaoi <-StreamCatTools::sc_get_params(param = 'aoi') #make list of all sc aois

streamcat <- purrr::map_dfr(comids, scaoi, ~StreamCatTools::sc_get_data(comid = .,
                                                                          metric = 'all',
                                                                          showAreaSqKm = TRUE,
                                                                          aoi = .))
return(streamcat)
}

doit <- myfunction(comids = comids, scaoi = scaoi)




for (i in comids) {
ws <- StreamCatTools::sc_get_data(i, metric = 'all', showAreaSqKm = TRUE, aoi='watershed')
}

for (i in comids) {
ca <- StreamCatTools::sc_get_data(i, metric = 'all', showAreaSqKm = TRUE, aoi='catchment')
}

for (i in comids) {
ot <- StreamCatTools::sc_get_data(i, metric = 'all', showAreaSqKm = TRUE, aoi='other')
}

allmets <- left_join(ws, ca, by = "comid")
```






```{r}
#Get list of COMIDs 
comids <- unique(tss.all$COMID)

#Remove blanks
comids <- comids[!is.na(comids)]

#Run function
get_streamcat <- function(comids){
  
comid_narm <- na.omit(comids)
comids_split <- split(comid_narm, ceiling(seq_along(comids)/650))

streamcat <- purrr::map_dfr(comids_split, ~StreamCatTools::sc_get_data(comid = .,
                                                                           metric = 'pctcrop2019',
                                                                           showAreaSqKm = TRUE,
                                                                           aoi='catchment,watershed,other'))

streamcat <- get_streamcat(comids = comids)

names(streamcat) <- base::toupper(names(streamcat))

return(streamcat)
}

streamcat <- get_streamcat(comids = comids)
```


