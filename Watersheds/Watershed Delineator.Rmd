---
title: "Watershed Delineator"
author: "A. Thompson, T. Pritchard"
date: "2026-01-27"
output: html_document
  TOC: TRUE
---

# **WATERSHED DELINEATION TOOL**

#### Purpose: Batch create watershed polygons upstream of a starting set of coordinates or COMIDs. Useful for evaluating human disturbances to screen sites for reference condition.

# **1 - ASSIGN COMIDS**

#### First assign and review COMIDs manually or via RATS' batch COMID script (<link>). All stations must have a valid COMID before proceeding.

# **2 - LOAD PACKAGES**

```{r}
library(tidyverse)
library(openxlsx)
library(sf)
library(mapview)
library(AWQMSdata) #<https://github.com/TravisPritchardODEQ/AWQMSdata>
library(nhdplusTools) #<https://doi-usgs.github.io/nhdplusTools/>
```

# **3 - OUTPUT SHAPEFILE**

#### Enter the file path where delineated watersheds will be saved. Output file path must be unique for tool to run and won't overwrite existing files.

```{r}
export <- "C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willytest2.shp"

if (file.exists(export)) {
  print("❌ The file already exists. Rename output file or delete existing file.")
} else {
  print("✅ The file does not exist. Proceed.")
}
```

# **4 - IMPORT DATA**

#### Choose *ONE* of the following three methods for importing sites/COMIDs. Update file path.

#### Use USGS StreamStats to delineate a single watershed <https://streamstats.usgs.gov/ss/>.

## OPTION A - *EXCEL*

```{r}
import <- read.xlsx("C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/WillyTable.xlsx")
```

## OPTION B - *SHAPEFILE*

```{r}
import <- st_read("C:/Users/athomps/OneDrive - Oregon/Desktop/New folder/willy.shp")
```

## OPTION C - *STATIONS DATABASE*

```{r}
import <- query_stations(mlocs = c("21848-ORDEQ","10404-ORDEQ","ODFW-10662")) #<--Enter desired MLocIDs in quotes separated by commas
```

# **5 - CREATE COMID DATAFRAME**

```{r}
# MAKE DATAFRAME CONTAINING ALL COMIDS FROM USER-SELECTED INPUT METHOD
# DROP ROWS WITH MISSING COMIDS (e.g., stations on high resolution NHD layer with no representative COMIDs, denoted by "-99999")
dataframe_comid <- import |>
  select(COMID, MLocID) |>
    filter(COMID != '-99999' | !is.na(COMID))

# CREATE TEMPORARY GEOPACKAGE
subset_file <- tempfile(fileext = ".gpkg")
```

# **6 - RUN DELINEATION FUNCTION**

```{r}
# RUN FUNCTION
delin <- function(comid, MLocID, save_file){

# MAKE FLOWLINES
flowlines <- navigate_nldi(list(featureSource = "comid",
                                featureID = comid),
                           mode = "upstreamTributaries",
                           distance_km = 1000)

# SUBSET DATA
subset <- subset_nhdplus(comids = as.integer(flowlines$UT$nhdplus_comid),
                         output_file = subset_file,
                         nhdplus_data = "download",
                         flowline_only = FALSE,
                         return_data = TRUE, overwrite = TRUE)

# CREATE CATCHMENT POLYGONS
catchment <- sf::read_sf(subset_file, "CatchmentSP")

# UNIFY INTO SINGLE POLYGON
catchment <- sf::st_union(catchment)

# DRAW THE FLOW NETWORK
flownet <- subset$NHDFlowline_Network

# REPROJECT TO NAD83 / OREGON GIC LAMBERT (ft)
catchment2 <- st_sf(catchment)|> 
  mutate(COMID = comid,
         MLocID = MLocID) |>
  st_transform(crs = 2992)

# CALCULATE WATERSHED AREA (m2)
catchment2$Shape_Area <- st_area(catchment2) * 0.092903

# APPEND WATERSHEDS TO SHAPEFILE
st_write(catchment2, save_file, append = TRUE)
}
```

# **7 - WRITE TO OUTPUT SHAPEFILE**

```{r}
purrr::pmap(dataframe_comid, ~delin(comid = {..1}, MLocID = {..2}, save_file = export))
```

# **8 - REVIEW WATERSHEDS IN GIS**

#### REFER TO STATEWIDE REFERENCE SELECTION PROTOCOLS (DEQ21-LAB-0026-SOP)

## ***THE END***
